<!DOCTYPE html>
<html lang=zh>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
    
    
        
            
                <link rel="shortcut icon" href="/images/favicon.ico">
            
        
        
            
                <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
            
        
        
            
                <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
            
        
    
    <!-- title -->
    <title>Turbo Rails Tutorial-第五章</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <link href="https://fonts.googleapis.com/css?family=Noto+Sans+SC&display=swap" rel="stylesheet">
    <link href="https://cdn.staticfile.org/firacode/6.2.0/fira_code.min.css" rel="stylesheet">
    <!-- rss -->
    
    
<meta name="generator" content="Hexo 5.4.2"></head>

<body class="max-width mx-auto px3 ltr">

    <div id="header-post">
    <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
    <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
    <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i
                class="fas fa-chevron-up fa-lg"></i></a>
    <span id="menu">
    <span id="nav">
      <ul>
          
              <li><a href="/">首页</a></li>
          
              <li><a href="/about/">关于</a></li>
          
              <li><a href="/archives/">归档</a></li>
          
              <li><a href="/categories/">分类</a></li>
          
              <li><a target="_blank" rel="noopener" href="https://github.com/GengCen-Qin">项目</a></li>
          
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
          
              <li><a class="icon" href="/post/Ruby/Hotails/%E7%AC%AC%E5%85%AD%E7%AB%A0.html"><i class="fas fa-chevron-left"
                                                                           aria-hidden="true"
                                                                           onmouseover="$('#i-prev').toggle();"
                                                                           onmouseout="$('#i-prev').toggle();"></i></a></li>
          
          
              <li><a class="icon" href="/post/Ruby/Hotails/%E7%AC%AC%E5%9B%9B%E7%AB%A0.html"><i class="fas fa-chevron-right"
                                                                           aria-hidden="true"
                                                                           onmouseover="$('#i-next').toggle();"
                                                                           onmouseout="$('#i-next').toggle();"></i></a></li>
          
          <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i
                          class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();"
                          onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" href="#"><i class="fas fa-share-alt" aria-hidden="true"
                                        onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();"
                                        onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">上一篇</span>
      <span id="i-next" class="info" style="display:none;">下一篇</span>
      <span id="i-top" class="info" style="display:none;">返回顶部</span>
      <span id="i-share" class="info" style="display:none;">分享文章</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
    <li><a class="icon"
           target="_blank" rel="noopener" href="https://sns.qzone.qq.com/cgi-bin/qzshare/cgi_qzshare_onekey?url=http://www.chengling.cloud/post/Ruby/Hotails/%E7%AC%AC%E4%BA%94%E7%AB%A0.html&title=Turbo Rails Tutorial-第五章"><i
                    class="fab fa-qq " aria-hidden="true"></i></a></li>
    <li><a class="icon"
           target="_blank" rel="noopener" href="https://service.weibo.com/share/share.php?url=http://www.chengling.cloud/post/Ruby/Hotails/%E7%AC%AC%E4%BA%94%E7%AB%A0.html&title=Turbo Rails Tutorial-第五章"><i
                    class="fab fa-weibo " aria-hidden="true"></i></a></li>
    <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://www.chengling.cloud/post/Ruby/Hotails/%E7%AC%AC%E4%BA%94%E7%AB%A0.html&text=Turbo Rails Tutorial-第五章"><i
                    class="fab fa-twitter " aria-hidden="true"></i></a></li>
    <li><a class="icon" href="mailto:?subject=Turbo Rails Tutorial-第五章&body=Check out this article: http://www.chengling.cloud/post/Ruby/Hotails/%E7%AC%AC%E4%BA%94%E7%AB%A0.html"><i
                    class="fas fa-envelope " aria-hidden="true"></i></a></li>
</ul>
    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Real-time-updates-with-Turbo-Streams"><span class="toc-number">1.</span> <span class="toc-text">Real-time updates with Turbo Streams</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%88%91%E4%BB%AC%E8%A6%81%E5%81%9A%E4%BB%80%E4%B9%88"><span class="toc-number">1.1.</span> <span class="toc-text">我们要做什么</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8Turbo-Stream%E5%B9%BF%E6%92%AD%E6%96%B0%E5%BB%BA%E7%9A%84quotes"><span class="toc-number">1.2.</span> <span class="toc-text">使用Turbo Stream广播新建的quotes</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Testing-Turbo-Streams-in-the-console"><span class="toc-number">1.3.</span> <span class="toc-text">Testing Turbo Streams in the console</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Testing-Turbo-Streams-with-two-browser-windows"><span class="toc-number">1.4.</span> <span class="toc-text">Testing Turbo Streams with two browser windows</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Turbo-Streams-conventions-and-syntactic-sugar"><span class="toc-number">1.5.</span> <span class="toc-text">Turbo Streams conventions and syntactic sugar</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Broadcasting-quote-updates-with-Turbo-Streams"><span class="toc-number">1.6.</span> <span class="toc-text">Broadcasting quote updates with Turbo Streams</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Broadcasting-quote-deletion-with-Turbo-Streams"><span class="toc-number">1.7.</span> <span class="toc-text">Broadcasting quote deletion with Turbo Streams</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Making-broadcasting-asynchronous-with-ActiveJob"><span class="toc-number">1.8.</span> <span class="toc-text">Making broadcasting asynchronous with ActiveJob</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9B%B4%E5%A4%9A%E7%9A%84%E8%AF%AD%E6%B3%95%E9%A2%98"><span class="toc-number">1.9.</span> <span class="toc-text">更多的语法题</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Wrap-up"><span class="toc-number">1.10.</span> <span class="toc-text">Wrap up</span></a></li></ol></li></ol>
    </div>
  </span>
</div>

<div class="content index py4">
    
    <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        Turbo Rails Tutorial-第五章
    </h1>

      <div class="meta">
        <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <span itemprop="name">
            
                  庚辰
                    
          </span>
        </span>
        
    <div class="postdate">
        
            <time datetime="2023-07-02T02:24:45.000Z"
                  itemprop="datePublished">2023-07-02</time>
            
                (Updated:
                <time datetime="2023-07-02T09:22:13.004Z"
                      itemprop="dateModified">2023-07-02</time>)
            
        
    </div>

          
    <div class="article-category">
        <i class="fas fa-archive"></i>
        <a class="category-link" href="/categories/Turbo-Rails/">Turbo-Rails</a>
    </div>

            
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link-link" href="/tags/Rails/" rel="tag">Rails</a>, <a class="tag-link-link" href="/tags/turbo/" rel="tag">turbo</a>
    </div>

      </div>
  </header>
  
    <div class="content" itemprop="articleBody">
      <p>​    </p>
<h1 id="Real-time-updates-with-Turbo-Streams"><a href="#Real-time-updates-with-Turbo-Streams" class="headerlink" title="Real-time updates with Turbo Streams"></a>Real-time updates with Turbo Streams</h1><p>本章节，我们将学习如何使用Action Cable 广播 Turbo Stream templates，来让我们的页面进行实时跟新。</p>
<p>Turbo Stream format 可以仅用几行代码就与 Action Cable结合，来让我们的页面实时更新，当然与：群聊，通知，邮箱服务是类似的。</p>
<p>让我们用邮箱服务来举例，比如当我们收到一封新的邮箱，我们不想去手动的刷新让它显示，相反我们希望它能自己在页面上更新，而不需要我们操作什么。</p>
<p>而实现这一功能对于Rails来说很容易，因为在Rails5时就发布了Active Cable。本章将要讨论的Turbo Rails的一部分是建立在Action Cable之上的，而实现该功能，也就更加简单了。</p>
<h2 id="我们要做什么"><a href="#我们要做什么" class="headerlink" title="我们要做什么"></a>我们要做什么</h2><p>来想象一下，如果有许多人同时使用我们的quote编辑器，他们更希望实时看到同事们都写了什么。</p>
<p>在<code>Quotes#index</code>页面：</p>
<ul>
<li>任何时候一个成员创建了新的quote，我们希望该quote立刻被加到我们的quotes列表的最上面</li>
<li>任何时候一个成员修改了一个quote，我们希望修改的内容，能立刻显示在页面上</li>
<li>任何时候一个成员删除了一个quote，我们希望被删除的内容，能立刻消失</li>
</ul>
<p>这听起来很麻烦。但这个需求可以让我们的学习如何使用Turbo Stream来在首页中实时的更新，</p>
<h2 id="使用Turbo-Stream广播新建的quotes"><a href="#使用Turbo-Stream广播新建的quotes" class="headerlink" title="使用Turbo Stream广播新建的quotes"></a>使用Turbo Stream广播新建的quotes</h2><p>为了做到这一点，我们必须告诉<code>Quote</code>模型去广播新建的quote的HTML在创建后，让我们来改改</p>
<pre class="line-numbers language-ruby" data-language="ruby"><code class="language-ruby"><span class="token comment"># app/models/quote.rb</span>

<span class="token keyword">class</span> <span class="token class-name">Quote</span> <span class="token operator">&lt;</span> ApplicationRecord
  <span class="token comment"># All the previous code</span>

  after_create_commit <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">&#123;</span> broadcast_prepend_to <span class="token string-literal"><span class="token string">"quotes"</span></span><span class="token punctuation">,</span> <span class="token symbol">partial</span><span class="token operator">:</span> <span class="token string-literal"><span class="token string">"quotes/quote"</span></span><span class="token punctuation">,</span> <span class="token symbol">locals</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token symbol">quote</span><span class="token operator">:</span> <span class="token keyword">self</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token symbol">target</span><span class="token operator">:</span> <span class="token string-literal"><span class="token string">"quotes"</span></span> <span class="token punctuation">&#125;</span>
<span class="token keyword">end</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>让我们先写下这些代码，当我们在浏览器中感受一下，就能更清晰的知道代码的含义了</p>
<p>首先，我们使用了<code>after_create_commit</code>回调去通知Rails，在每次向数据库内新加一条数据时，执行这个lambda表达式</p>
<p>第二段lanbda表达式中的代码就更复杂了，它会通知rails，新建的quote对应的HTML应该被广播到那些订阅了<code>quotes stream</code>的用户那里，并在DOM中放到id为<code>quotes</code>的节点前面</p>
<p>我们将会解释到底该怎么做，但现在我们应注意生成的HTML是什么样子的。</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>turbo-stream</span> <span class="token attr-name">action</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>prepend<span class="token punctuation">"</span></span> <span class="token attr-name">target</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>quotes<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>turbo-frame</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>quote_123<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
      <span class="token comment">&lt;!-- The HTML for the quote partial --></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>turbo-frame</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>turbo-stream</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>有没有感觉这个代码很眼熟，和我们上一节中<code>QutoesController#create</code>将新创建的数据放到quotes列表的前面，所生成的HTML代码是一样的。</p>
<p><strong>唯一不同的是，这次的HTML是通过WebSocket传递的，而不是通过ajax的响应</strong></p>
<hr>
<p><strong>注意：</strong>这里的例子我们是将新加的数据放到最前面，我们当然也可以使用<code>broadcast_append_to</code>去把新加的数据，放到列表的后面</p>
<hr>
<p>为了能够订阅到<code>quotes</code>流，我们需要在<code>Quotes#index</code>中加入下面的代码</p>
<pre class="line-numbers language-ruby" data-language="ruby"><code class="language-ruby"><span class="token operator">&lt;</span><span class="token string-literal"><span class="token string">%# app/views/quotes/index.html.erb %>

&lt;%= turbo_stream_from "quotes" %>

&lt;%#</span></span> All the previous <span class="token constant">HTML</span> markup <span class="token operator">%</span><span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>而这段代码生成的HTML是这样子的：</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>turbo-cable-stream-source</span>
  <span class="token attr-name">channel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Turbo::StreamsChannel<span class="token punctuation">"</span></span>
  <span class="token attr-name">signed-stream-name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>very-long-string<span class="token punctuation">"</span></span>
<span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>turbo-cable-stream-source</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>可以看到生成了一段来源于Turbo JavaScript Library的自定义标签，用订阅用户到在channel属性中命名的通道，更具体地说，是在signed-stream-name属性中命名的流。</p>
<p><code>Turbo::StreamsChannel</code>里面的<code>channel</code>参数名就是Action Cable channel 的名字，Turbo Rails总会使用这个channel，所以这个参数名始终是一样的。</p>
<p><code>signed-stream-name</code>参数是使用<code>quotes</code>的一个签名，它是为了防止一些恶意用户干预并从流中获取我们的HTML。这个我们会在下一章中细讲，现在你只需要知道这个长的字符串，解码后就<code>quotes</code></p>
<p>现在所有的<code>Quotes#index</code>页面中的用户都能监听到这个<code>Turbo::StreamsChannel</code>，并等待<code>quotes</code>流中的订阅数据，每当给数据库添加一个新的数据时，这些用户将收到<code>Turbo Stream format</code>中的HTML，并把数据放到相应的位置。</p>
<p>现在让我们看看是不是像我们预想的一样，下面会介绍两种方式去测试我们的代码</p>
<h2 id="Testing-Turbo-Streams-in-the-console"><a href="#Testing-Turbo-Streams-in-the-console" class="headerlink" title="Testing Turbo Streams in the console"></a>Testing Turbo Streams in the console</h2><p><strong>本章中，每次我们对<code>Quote</code>模型做修改时，我们都需要重启rails console在测试之前，否则会出现些意料之外的事儿</strong></p>
<hr>
<p><strong>注意：</strong>我们在console中测试前，需要确保Redis被正确的配置在应用中。</p>
<p>在开发环境，你的<code>config/cable.yml</code>应该长下面的样子：</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token comment"># config/cable.yml</span>

<span class="token key atrule">development</span><span class="token punctuation">:</span>
  <span class="token key atrule">adapter</span><span class="token punctuation">:</span> redis
  <span class="token key atrule">url</span><span class="token punctuation">:</span> redis<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span>6379/1

<span class="token comment"># All the rest of the file</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>如果情况一致，那你可以忽略下面的提示了。</p>
<hr>
<p>否则，你应该下载Redis，然后运行：<code>bin/rails turbo:install</code>，它会修改<code>config/cable.yml</code>文件中的配置，如果没问题了，就可以继续往下了</p>
<hr>
<p>现在我们在浏览器中，打开<code>Quotes#index</code>页面，然后在rails console中创建一个新的quote：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">Quote.create<span class="token operator">!</span><span class="token punctuation">(</span>name: <span class="token string">"Broadcasted quote"</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>然我们在console logs中看看发生了什么？第一件事儿：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">TRANSACTION <span class="token punctuation">(</span><span class="token number">0</span>.1ms<span class="token punctuation">)</span>  begin transaction
Quote Create <span class="token punctuation">(</span><span class="token number">0</span>.4ms<span class="token punctuation">)</span>  INSERT INTO <span class="token string">"quotes"</span> <span class="token punctuation">(</span><span class="token string">"name"</span>, <span class="token string">"created_at"</span>, <span class="token string">"updated_at"</span><span class="token punctuation">)</span> VALUES <span class="token punctuation">(</span>?, ?, ?<span class="token punctuation">)</span>  <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">"name"</span>, <span class="token string">"Broadcasted quote"</span><span class="token punctuation">]</span>, <span class="token punctuation">[</span><span class="token string">"created_at"</span>, <span class="token string">"2021-10-16 12:03:54.401034"</span><span class="token punctuation">]</span>, <span class="token punctuation">[</span><span class="token string">"updated_at"</span>, <span class="token string">"2021-10-16 12:03:54.401034"</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
TRANSACTION <span class="token punctuation">(</span><span class="token number">0</span>.8ms<span class="token punctuation">)</span>  commit transaction<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>可以看到，插入一条新的数据，然后事务提交，再往下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">Rendered quotes/_quote.html.erb <span class="token punctuation">(</span>Duration: <span class="token number">0</span>.5ms <span class="token operator">|</span> Allocations: <span class="token number">285</span><span class="token punctuation">)</span>
<span class="token punctuation">[</span>ActionCable<span class="token punctuation">]</span> Broadcasting to quotes: <span class="token string">"&lt;turbo-stream action=<span class="token entity" title="\&quot;">\"</span>prepend<span class="token entity" title="\&quot;">\"</span> target=<span class="token entity" title="\&quot;">\"</span>quotes<span class="token entity" title="\&quot;">\"</span>>&lt;template>&lt;turbo-frame id=<span class="token entity" title="\&quot;">\"</span>quote_908005754<span class="token entity" title="\&quot;">\"</span>><span class="token entity" title="\n">\n</span>The HTML of our quotes/_quote.html.erb partial&lt;/turbo-frame>&lt;/template>&lt;/turbo-stream>"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>内容很长，但确实很有趣的一部分</p>
<p>首先我们注意到，通过<code>ActionCable</code>广播了一段HTML到名字为<code>quotes</code>的流中，由于我们刚才在<code>Quotes#index</code>页面中加入了<code>turbo_stream_from &#39;quotes&#39;</code>，所以我们可以订阅到Stream，并获取到它广播通知的HTML</p>
<p>其次我们注意到，被广播通知的HTML是在Turbo Stream format中，它会通知Turbo去将<template>中的内容放到<code>quotes</code>的前面，这不这是我们让模型去做的事儿吗？</p>
<p>最后我们看到了生成的<template>中的HTML正是<code>quotes/_quote.html.erb</code>的数据，并且是我们刚刚创建的数据，当Turbo 在前端获取到模版时，它就会放到id为quotes中DOM节点前面。</p>
<p>我们画个草图来说明一下，现在的<code>Quotes#index</code>页面长下面的样子：</p>
<p><img src="../../../../public/img/image-20230607225702833.png" alt="image-20230607225702833"></p>
<p>想象一下，一个同事新创建了一条数据</p>
<p>由于<code>after_create_commit</code>的回调，当新创建数据后，<code>broadcasts_prepend_to</code>方法将被调用</p>
<p><img src="../../../../public/img/image-20230607225938559.png" alt="image-20230607225938559"></p>
<p>而在浏览器中，我们应该可以看到命名为“Broadcasted quote”已经被实时的加到列表的前面</p>
<p><img src="../../../../public/img/image-20230607230050674.png" alt="image-20230607230050674"></p>
<p>由于构建于Action Cable之上的Turbo Rails，这些修改都能被立刻的显示在页面中，我们不再需要刷新页面，我们仅仅使用了几行代码就让我们的系统具有了实时性的特点。</p>
<h2 id="Testing-Turbo-Streams-with-two-browser-windows"><a href="#Testing-Turbo-Streams-with-two-browser-windows" class="headerlink" title="Testing Turbo Streams with two browser windows"></a>Testing Turbo Streams with two browser windows</h2><p>另一种方式就是，使用浏览器打开两个页面，一个页面进项操作，看另外一个页面是否可以实时更新。</p>
<h2 id="Turbo-Streams-conventions-and-syntactic-sugar"><a href="#Turbo-Streams-conventions-and-syntactic-sugar" class="headerlink" title="Turbo Streams conventions and syntactic sugar"></a>Turbo Streams conventions and syntactic sugar</h2><p>让我们来简化一下先前在<code>Quote</code>模型中的操作</p>
<pre class="line-numbers language-ruby" data-language="ruby"><code class="language-ruby"><span class="token comment"># app/models/quote.rb</span>

<span class="token keyword">class</span> <span class="token class-name">Quote</span> <span class="token operator">&lt;</span> ApplicationRecord
  <span class="token comment"># All the previous code</span>

  after_create_commit <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">&#123;</span> broadcast_prepend_to <span class="token string-literal"><span class="token string">"quotes"</span></span><span class="token punctuation">,</span> <span class="token symbol">partial</span><span class="token operator">:</span> <span class="token string-literal"><span class="token string">"quotes/quote"</span></span><span class="token punctuation">,</span> <span class="token symbol">locals</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token symbol">quote</span><span class="token operator">:</span> <span class="token keyword">self</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token symbol">target</span><span class="token operator">:</span> <span class="token string-literal"><span class="token string">"quotes"</span></span> <span class="token punctuation">&#125;</span>
<span class="token keyword">end</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>上面的代码中，我们指定了<code>target: &quot;quotes&quot;</code>，而默认的target就是模型的复数形式，也就相当于我们这里的quotes，所以根据约定，target这部分我们可以省略</p>
<pre class="line-numbers language-ruby" data-language="ruby"><code class="language-ruby"><span class="token comment"># app/models/quote.rb</span>

<span class="token keyword">class</span> <span class="token class-name">Quote</span> <span class="token operator">&lt;</span> ApplicationRecord
  <span class="token comment"># All the previous code</span>

  after_create_commit <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">&#123;</span> broadcast_prepend_to <span class="token string-literal"><span class="token string">"quotes"</span></span><span class="token punctuation">,</span> <span class="token symbol">partial</span><span class="token operator">:</span> <span class="token string-literal"><span class="token string">"quotes/quote"</span></span><span class="token punctuation">,</span> <span class="token symbol">locals</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token symbol">quote</span><span class="token operator">:</span> <span class="token keyword">self</span> <span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span>
<span class="token keyword">end</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>还有两个约定，可以缩减我们的代码，底层中，<code>partial and locals</code>选项都有默认的值</p>
<p><code>partial</code>的默认值等于 model示例调用<code>to_partial_path</code>，对于<code>Quote</code>模型，就相当于<code>quotes/quote</code>。</p>
<p><code>locals</code>默认值等于<code>&#123; model_name.element.to_sym =&gt; self &#125;</code>,对于<code>Quote</code>模型，就相当于<code>&#123;quote:self&#125;</code>。</p>
<p>所以最终我们的代码被简化为下面的样子：</p>
<pre class="line-numbers language-ruby" data-language="ruby"><code class="language-ruby"><span class="token comment"># app/models/quote.rb</span>

<span class="token keyword">class</span> <span class="token class-name">Quote</span> <span class="token operator">&lt;</span> ApplicationRecord
  <span class="token comment"># All the previous code</span>

  after_create_commit <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">&#123;</span> broadcast_prepend_to <span class="token string-literal"><span class="token string">"quotes"</span></span> <span class="token punctuation">&#125;</span>
<span class="token keyword">end</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>根据约定大于配置，我们的代码只需要几行代码就可以完成任务了。</p>
<p>现在我们已经知道了Turbo Streams是如何运转的，让我们直接改进我们的增删改查代码。</p>
<h2 id="Broadcasting-quote-updates-with-Turbo-Streams"><a href="#Broadcasting-quote-updates-with-Turbo-Streams" class="headerlink" title="Broadcasting quote updates with Turbo Streams"></a>Broadcasting quote updates with Turbo Streams</h2><p>增加的效果已经出来了，现在我们让修改也生效</p>
<p>修改模型：</p>
<pre class="line-numbers language-ruby" data-language="ruby"><code class="language-ruby"><span class="token comment"># app/models/quote.rb</span>

<span class="token keyword">class</span> <span class="token class-name">Quote</span> <span class="token operator">&lt;</span> ApplicationRecord
  <span class="token comment"># All the previous code</span>

  after_create_commit <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">&#123;</span> broadcast_prepend_to <span class="token string-literal"><span class="token string">"quotes"</span></span> <span class="token punctuation">&#125;</span>
  after_update_commit <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">&#123;</span> broadcast_replace_to <span class="token string-literal"><span class="token string">"quotes"</span></span> <span class="token punctuation">&#125;</span>
<span class="token keyword">end</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>如果你去浏览器或者控制台测试，会发现功能已经做完了。</p>
<p>让我们在rails console测试一下，并解释一下发生了什么</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">Quote.first.update<span class="token operator">!</span><span class="token punctuation">(</span>name: <span class="token string">"Update from console"</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">Quote Load <span class="token punctuation">(</span><span class="token number">0</span>.3ms<span class="token punctuation">)</span>  SELECT <span class="token string">"quotes"</span>.* FROM <span class="token string">"quotes"</span> ORDER BY <span class="token string">"quotes"</span><span class="token builtin class-name">.</span><span class="token string">"id"</span> ASC LIMIT ?  <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">"LIMIT"</span>, <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
TRANSACTION <span class="token punctuation">(</span><span class="token number">0</span>.0ms<span class="token punctuation">)</span>  begin transaction
Quote Update <span class="token punctuation">(</span><span class="token number">0</span>.3ms<span class="token punctuation">)</span>  UPDATE <span class="token string">"quotes"</span> SET <span class="token string">"name"</span> <span class="token operator">=</span> ?, <span class="token string">"updated_at"</span> <span class="token operator">=</span> ? WHERE <span class="token string">"quotes"</span><span class="token builtin class-name">.</span><span class="token string">"id"</span> <span class="token operator">=</span> ?  <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">"name"</span>, <span class="token string">"Update from console"</span><span class="token punctuation">]</span>, <span class="token punctuation">[</span><span class="token string">"updated_at"</span>, <span class="token string">"2021-10-16 12:48:02.987708"</span><span class="token punctuation">]</span>, <span class="token punctuation">[</span><span class="token string">"id"</span>, <span class="token number">908005754</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
TRANSACTION <span class="token punctuation">(</span><span class="token number">1</span>.6ms<span class="token punctuation">)</span>  commit transaction<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>可以看到还是修改数据库，然后提交事务，当事务提交完毕后，<code>Quote</code>模型的 <code>after_update_commit</code>回调被触发，并且调用<code>broadcast_replace_to</code>方法</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">Rendered quotes/_quote.html.erb <span class="token punctuation">(</span>Duration: <span class="token number">0</span>.6ms <span class="token operator">|</span> Allocations: <span class="token number">285</span><span class="token punctuation">)</span>
<span class="token punctuation">[</span>ActionCable<span class="token punctuation">]</span> Broadcasting to quotes: <span class="token string">"&lt;turbo-stream action=<span class="token entity" title="\&quot;">\"</span>replace<span class="token entity" title="\&quot;">\"</span> target=<span class="token entity" title="\&quot;">\"</span>quote_908005754<span class="token entity" title="\&quot;">\"</span>>&lt;template>&lt;turbo-frame id=<span class="token entity" title="\&quot;">\"</span>quote_908005754<span class="token entity" title="\&quot;">\"</span>><span class="token entity" title="\n">\n</span>HTML from the quotes/quote partial&lt;/turbo-frame>&lt;/template>&lt;/turbo-stream>"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>像上次一样，我们看到了<code>quotes/quote</code>局部页面的HTML被广播到<code>quotes</code>流中，与上次不同，这次是<code>replace</code>而不是<code>prepend</code>，目标的DOM节点是id=quote_908005754的quote card，而它也就是要被更新的内容。</p>
<p><img src="../../../../public/img/image-20230608104009149.png" alt="image-20230608104009149"></p>
<p>而Turbo拦截被获取的HTML，并替换这个quote</p>
<p><img src="../../../../public/img/image-20230608104049888.png" alt="image-20230608104049888"></p>
<p>下面我们就来实现，如何实时的删除数据</p>
<h2 id="Broadcasting-quote-deletion-with-Turbo-Streams"><a href="#Broadcasting-quote-deletion-with-Turbo-Streams" class="headerlink" title="Broadcasting quote deletion with Turbo Streams"></a>Broadcasting quote deletion with Turbo Streams</h2><p>修改模型：</p>
<pre class="line-numbers language-ruby" data-language="ruby"><code class="language-ruby"><span class="token comment"># app/models/quote.rb</span>

<span class="token keyword">class</span> <span class="token class-name">Quote</span> <span class="token operator">&lt;</span> ApplicationRecord
  <span class="token comment"># All the previous code</span>

  after_create_commit <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">&#123;</span> broadcast_prepend_to <span class="token string-literal"><span class="token string">"quotes"</span></span> <span class="token punctuation">&#125;</span>
  after_update_commit <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">&#123;</span> broadcast_replace_to <span class="token string-literal"><span class="token string">"quotes"</span></span> <span class="token punctuation">&#125;</span>
  after_destroy_commit <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">&#123;</span> broadcast_remove_to <span class="token string-literal"><span class="token string">"quotes"</span></span> <span class="token punctuation">&#125;</span>
<span class="token keyword">end</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>测试一下，发现功能又完成了，我们在 rails console 中看看到底发生了什么</p>
<p>执行：确保数据库有数据</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">Quote.last.destroy<span class="token operator">!</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>删除数据，提交事务</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">Quote Load <span class="token punctuation">(</span><span class="token number">0</span>.3ms<span class="token punctuation">)</span>  SELECT <span class="token string">"quotes"</span>.* FROM <span class="token string">"quotes"</span> ORDER BY <span class="token string">"quotes"</span><span class="token builtin class-name">.</span><span class="token string">"id"</span> DESC LIMIT ?  <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">"LIMIT"</span>, <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
TRANSACTION <span class="token punctuation">(</span><span class="token number">0</span>.1ms<span class="token punctuation">)</span>  begin transaction
Quote Destroy <span class="token punctuation">(</span><span class="token number">0</span>.4ms<span class="token punctuation">)</span>  DELETE FROM <span class="token string">"quotes"</span> WHERE <span class="token string">"quotes"</span><span class="token builtin class-name">.</span><span class="token string">"id"</span> <span class="token operator">=</span> ?  <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">"id"</span>, <span class="token number">908005754</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
TRANSACTION <span class="token punctuation">(</span><span class="token number">1</span>.4ms<span class="token punctuation">)</span>  commit transaction<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>提交事务后，进行<code>after_destroy_commit</code>的模型回调，并调用<code>broadcast_remove_to</code>。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>ActionCable<span class="token punctuation">]</span> Broadcasting to quotes: <span class="token string">"&lt;turbo-stream action=<span class="token entity" title="\&quot;">\"</span>remove<span class="token entity" title="\&quot;">\"</span> target=<span class="token entity" title="\&quot;">\"</span>quote_908005754<span class="token entity" title="\&quot;">\"</span>>&lt;/turbo-stream>"</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>页面中用户从<code>quotes</code>流中获取数据，并且让Turbo去删除id为<code>quote_908005754</code>的DOM节点，然后这部分就是要被删除的。</p>
<p><img src="../../../../public/img/image-20230608105152332.png" alt="image-20230608105152332"></p>
<p>最终，这条quote数据就消失在<code>Quotes#index</code>页面中。</p>
<p><img src="../../../../public/img/image-20230608105234463.png" alt="image-20230608105234463"></p>
<p>就这样，我们改造了我们的增删改查，不过在进入下一章前，我们聊聊性能。</p>
<h2 id="Making-broadcasting-asynchronous-with-ActiveJob"><a href="#Making-broadcasting-asynchronous-with-ActiveJob" class="headerlink" title="Making broadcasting asynchronous with ActiveJob"></a>Making broadcasting asynchronous with ActiveJob</h2><p>现在我们的<code>Quote</code>模型长这个样子</p>
<pre class="line-numbers language-ruby" data-language="ruby"><code class="language-ruby"><span class="token comment"># app/models/quote.rb</span>

<span class="token keyword">class</span> <span class="token class-name">Quote</span> <span class="token operator">&lt;</span> ApplicationRecord
  <span class="token comment"># All the previous code</span>

  after_create_commit <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">&#123;</span> broadcast_prepend_to <span class="token string-literal"><span class="token string">"quotes"</span></span> <span class="token punctuation">&#125;</span>
  after_update_commit <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">&#123;</span> broadcast_replace_to <span class="token string-literal"><span class="token string">"quotes"</span></span> <span class="token punctuation">&#125;</span>
  after_destroy_commit <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">&#123;</span> broadcast_remove_to <span class="token string-literal"><span class="token string">"quotes"</span></span> <span class="token punctuation">&#125;</span>
<span class="token keyword">end</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>我们可以通过使广播异步化去提升我们代码的性能，为了这一点，我们需要使用异步等价的语法去修改回调内容。</p>
<pre class="line-numbers language-ruby" data-language="ruby"><code class="language-ruby"><span class="token comment"># app/models/quote.rb</span>

<span class="token keyword">class</span> <span class="token class-name">Quote</span> <span class="token operator">&lt;</span> ApplicationRecord
  <span class="token comment"># All the previous code</span>

  after_create_commit <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">&#123;</span> broadcast_prepend_later_to <span class="token string-literal"><span class="token string">"quotes"</span></span> <span class="token punctuation">&#125;</span>
  after_update_commit <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">&#123;</span> broadcast_replace_later_to <span class="token string-literal"><span class="token string">"quotes"</span></span> <span class="token punctuation">&#125;</span>
  after_destroy_commit <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">&#123;</span> broadcast_remove_to <span class="token string-literal"><span class="token string">"quotes"</span></span> <span class="token punctuation">&#125;</span>
<span class="token keyword">end</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<hr>
<p><strong>注意：</strong>prepend,replace都有_later_to方法，但remove没有，因为当一条quote被数据库删除了，那异步任务就没法在之后去检索这条数据执行任务了</p>
<hr>
<p>让我们在 rails console 中测试一下，看一些有什么区别</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">Quote.create<span class="token operator">!</span><span class="token punctuation">(</span>name: <span class="token string">"Asynchronous quote"</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>看看最新的日志，我们发现创建数据的日志和之前一样，但是广播的部分被异步化了，一个<code>Turbo::Streams::ActionBroadcastJob</code>加入了队列，并附带了必要的数据，用来后续的广播</p>
<pre class="line-numbers language-ruby" data-language="ruby"><code class="language-ruby">Enqueued Turbo<span class="token double-colon punctuation">::</span>Streams<span class="token double-colon punctuation">::</span>ActionBroadcastJob <span class="token punctuation">(</span>Job <span class="token constant">ID</span><span class="token operator">:</span> <span class="token number">1</span>eecd0c8<span class="token operator">-</span><span class="token number">53</span>fd<span class="token operator">-</span><span class="token number">43</span>ed<span class="token operator">-</span>af8a<span class="token operator">-</span><span class="token number">073</span>b7d85c2fe<span class="token punctuation">)</span> to Async<span class="token punctuation">(</span>default<span class="token punctuation">)</span> with arguments<span class="token operator">:</span> <span class="token string-literal"><span class="token string">"quotes"</span></span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token symbol">:action</span><span class="token operator">=></span><span class="token symbol">:prepend</span><span class="token punctuation">,</span> <span class="token symbol">:target</span><span class="token operator">=></span><span class="token string-literal"><span class="token string">"quotes"</span></span><span class="token punctuation">,</span> <span class="token symbol">:targets</span><span class="token operator">=></span><span class="token keyword">nil</span><span class="token punctuation">,</span> <span class="token symbol">:locals</span><span class="token operator">=></span><span class="token punctuation">&#123;</span><span class="token symbol">:quote</span><span class="token operator">=></span><span class="token comment">#&lt;GlobalID:0x00007f9a39e861a8 @uri=#&lt;URI::GID gid://hotwire-course/Quote/908005756>>&#125;, :partial=>"quotes/quote"&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>然后这个任务就被渲染为<code>quotes/_quote.html.erb</code>局部视图那样</p>
<pre class="line-numbers language-ruby" data-language="ruby"><code class="language-ruby">Performing Turbo<span class="token double-colon punctuation">::</span>Streams<span class="token double-colon punctuation">::</span>ActionBroadcastJob <span class="token punctuation">(</span>Job <span class="token constant">ID</span><span class="token operator">:</span> <span class="token number">1</span>eecd0c8<span class="token operator">-</span><span class="token number">53</span>fd<span class="token operator">-</span><span class="token number">43</span>ed<span class="token operator">-</span>af8a<span class="token operator">-</span><span class="token number">073</span>b7d85c2fe<span class="token punctuation">)</span> from Async<span class="token punctuation">(</span>default<span class="token punctuation">)</span> enqueued at <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">16</span>T17<span class="token operator">:</span><span class="token number">24</span><span class="token operator">:</span><span class="token number">32</span>Z with arguments<span class="token operator">:</span> <span class="token string-literal"><span class="token string">"quotes"</span></span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token symbol">:action</span><span class="token operator">=></span><span class="token symbol">:prepend</span><span class="token punctuation">,</span> <span class="token symbol">:target</span><span class="token operator">=></span><span class="token string-literal"><span class="token string">"quotes"</span></span><span class="token punctuation">,</span> <span class="token symbol">:targets</span><span class="token operator">=></span><span class="token keyword">nil</span><span class="token punctuation">,</span> <span class="token symbol">:locals</span><span class="token operator">=></span><span class="token punctuation">&#123;</span><span class="token symbol">:quote</span><span class="token operator">=></span><span class="token comment">#&lt;GlobalID:0x00007f9a3e03a630 @uri=#&lt;URI::GID gid://hotwire-course/Quote/908005756>>&#125;, :partial=>"quotes/quote"&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>异步广播Turbo Stream是我们性能优化的首选之举。</p>
<h2 id="更多的语法题"><a href="#更多的语法题" class="headerlink" title="更多的语法题"></a>更多的语法题</h2><p>如果我们的模型拥有多个实时性任务，我们会注意到回调函数写的都很类似，而Rails就是一个约定大于配置的框架，所以让我们使用语法题去避免重复的语句，让我们来修改模型吧。</p>
<pre class="line-numbers language-ruby" data-language="ruby"><code class="language-ruby"><span class="token comment"># app/models/quote.rb</span>

<span class="token keyword">class</span> <span class="token class-name">Quote</span> <span class="token operator">&lt;</span> ApplicationRecord
  <span class="token comment"># All the previous code</span>

  <span class="token comment"># after_create_commit -> &#123; broadcast_prepend_later_to "quotes" &#125;</span>
  <span class="token comment"># after_update_commit -> &#123; broadcast_replace_later_to "quotes" &#125;</span>
  <span class="token comment"># after_destroy_commit -> &#123; broadcast_remove_to "quotes" &#125;</span>
  <span class="token comment"># Those three callbacks are equivalent to the following single line</span>
  broadcasts_to <span class="token operator">-</span><span class="token operator">></span><span class="token punctuation">(</span>quote<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token string-literal"><span class="token string">"quotes"</span></span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token symbol">inserts_by</span><span class="token operator">:</span> <span class="token symbol">:prepend</span>
<span class="token keyword">end</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>三个回到等同于下面的一行代码，我们将会在下一章（安全性）中讨论为什么需要lambda表达式。现在我们只需要知道，我们的增删改都被异步的广播到了<code>quotes</code>流中。</p>
<p>我们的模型别简化为：</p>
<pre class="line-numbers language-ruby" data-language="ruby"><code class="language-ruby"><span class="token comment"># app/models/quote.rb</span>

<span class="token keyword">class</span> <span class="token class-name">Quote</span> <span class="token operator">&lt;</span> ApplicationRecord
  <span class="token comment"># All the previous code</span>

  broadcasts_to <span class="token operator">-</span><span class="token operator">></span><span class="token punctuation">(</span>quote<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token string-literal"><span class="token string">"quotes"</span></span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token symbol">inserts_by</span><span class="token operator">:</span> <span class="token symbol">:prepend</span>
<span class="token keyword">end</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="Wrap-up"><a href="#Wrap-up" class="headerlink" title="Wrap up"></a>Wrap up</h2><p>让我们的项目具有实时性，我们只需要简单的两行代码</p>
<ul>
<li>模型中，我们设置增删改的回调方法，而得助于约定，三个回调被定义为一行代码</li>
<li><code>Quotes#index</code>页面中，我们定义关注<code>quotes</code>流</li>
</ul>
<p>剩下的事儿就交给Turbo完成吧</p>
<p>下一章，我们将会聊聊安全相关内容，我们将讨论如何让Turbo Stream确保被不会广播数据到异常的用户那里。</p>

    </div>
</article>



  <script>
    //检测推送
    var pushType = "";
    var pushLink = "";
    var siteName = "玲辰书斋";

    var ValineButton = document.getElementsByClassName("vsubmit vbtn")[0];
    //分情况推送
    if (pushType === "cp") {
      var title = siteName + "上又有新评论啦~!\n";
      function send_valine_CoolPush() {
        //获取元素信息
        var pagename = document.title;
        var wz = pagename.indexOf("|");
        var res = pagename.substring(0, wz);
        var pageurl = document.URL;
        var ptime = new Date();
        var vnick = document.getElementsByClassName("vnick vinput")[0].value;
        var vmail = document.getElementsByClassName("vmail vinput")[0].value;
        var vlink = document.getElementsByClassName("vlink vinput")[0].value;
        var veditor = document.getElementsByClassName("veditor vinput")[0].value;
        var data =
          "昵称: " +
          vnick +
          "\n\n邮箱: " +
          vmail +
          "\n\n网站地址: " +
          vlink +
          "\n\n当前页面: " +
          pagename +
          "\n\n评论内容: " +
          veditor +
          "\n\n跳转链接: " +
          pageurl +
          "\n\n评论时间: " +
          ptime.toLocaleString();
        var httpRequest = new XMLHttpRequest(); //第一步：创建需要的对象
        httpRequest.open("POST", pushLink, true); //第二步：打开连接
        httpRequest.setRequestHeader(
          "Content-type",
          "application/json"
        ); //设置请求头 注：post方式必须设置请求头（在建立连接后设置请求头）
        var payload = { "t": title, "c": data }
        httpRequest.send(JSON.stringify(payload)); //发送请求 将情头体写在send中
      }
      ValineButton.onclick = send_valine_CoolPush;
    }
  </script>
    
        <div id="footer-post-container">
    <div id="footer-post">

        <div id="nav-footer" style="display: none">
            <ul>
                
                    <li><a href="/">首页</a></li>
                
                    <li><a href="/about/">关于</a></li>
                
                    <li><a href="/archives/">归档</a></li>
                
                    <li><a href="/categories/">分类</a></li>
                
                    <li><a target="_blank" rel="noopener" href="https://github.com/GengCen-Qin">项目</a></li>
                
            </ul>
        </div>

        <div id="toc-footer" style="display: none">
            <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Real-time-updates-with-Turbo-Streams"><span class="toc-number">1.</span> <span class="toc-text">Real-time updates with Turbo Streams</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%88%91%E4%BB%AC%E8%A6%81%E5%81%9A%E4%BB%80%E4%B9%88"><span class="toc-number">1.1.</span> <span class="toc-text">我们要做什么</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8Turbo-Stream%E5%B9%BF%E6%92%AD%E6%96%B0%E5%BB%BA%E7%9A%84quotes"><span class="toc-number">1.2.</span> <span class="toc-text">使用Turbo Stream广播新建的quotes</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Testing-Turbo-Streams-in-the-console"><span class="toc-number">1.3.</span> <span class="toc-text">Testing Turbo Streams in the console</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Testing-Turbo-Streams-with-two-browser-windows"><span class="toc-number">1.4.</span> <span class="toc-text">Testing Turbo Streams with two browser windows</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Turbo-Streams-conventions-and-syntactic-sugar"><span class="toc-number">1.5.</span> <span class="toc-text">Turbo Streams conventions and syntactic sugar</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Broadcasting-quote-updates-with-Turbo-Streams"><span class="toc-number">1.6.</span> <span class="toc-text">Broadcasting quote updates with Turbo Streams</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Broadcasting-quote-deletion-with-Turbo-Streams"><span class="toc-number">1.7.</span> <span class="toc-text">Broadcasting quote deletion with Turbo Streams</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Making-broadcasting-asynchronous-with-ActiveJob"><span class="toc-number">1.8.</span> <span class="toc-text">Making broadcasting asynchronous with ActiveJob</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9B%B4%E5%A4%9A%E7%9A%84%E8%AF%AD%E6%B3%95%E9%A2%98"><span class="toc-number">1.9.</span> <span class="toc-text">更多的语法题</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Wrap-up"><span class="toc-number">1.10.</span> <span class="toc-text">Wrap up</span></a></li></ol></li></ol>
        </div>

        <div id="share-footer" style="display: none">
            <ul>
    <li><a class="icon"
           target="_blank" rel="noopener" href="https://sns.qzone.qq.com/cgi-bin/qzshare/cgi_qzshare_onekey?url=http://www.chengling.cloud/post/Ruby/Hotails/%E7%AC%AC%E4%BA%94%E7%AB%A0.html&title=Turbo Rails Tutorial-第五章"><i
                    class="fab fa-qq fa-lg" aria-hidden="true"></i></a></li>
    <li><a class="icon"
           target="_blank" rel="noopener" href="https://service.weibo.com/share/share.php?url=http://www.chengling.cloud/post/Ruby/Hotails/%E7%AC%AC%E4%BA%94%E7%AB%A0.html&title=Turbo Rails Tutorial-第五章"><i
                    class="fab fa-weibo fa-lg" aria-hidden="true"></i></a></li>
    <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://www.chengling.cloud/post/Ruby/Hotails/%E7%AC%AC%E4%BA%94%E7%AB%A0.html&text=Turbo Rails Tutorial-第五章"><i
                    class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
    <li><a class="icon" href="mailto:?subject=Turbo Rails Tutorial-第五章&body=Check out this article: http://www.chengling.cloud/post/Ruby/Hotails/%E7%AC%AC%E4%BA%94%E7%AB%A0.html"><i
                    class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
</ul>
        </div>

        <div id="actions-footer">
            <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i
                        class="fas fa-bars fa-lg"
                        aria-hidden="true"></i> 菜单</a>
            <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i
                        class="fas fa-list fa-lg"
                        aria-hidden="true"></i> 目录</a>
            <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i
                        class="fas fa-share-alt fa-lg" aria-hidden="true"></i> 分享</a>
            <a id="top" style="display:none" class="icon" href="#"
               onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg"
                                                                               aria-hidden="true"></i> 返回顶部
            </a>
        </div>

    </div>
</div>
    
    <footer id="footer">
  <div class="footer-top">
    &copy; 2025 <i class="fas fa-heart"></i>
    庚辰 
    <a href="http://www.beian.miit.gov.cn/" target="_blank">湘ICP备17005082号</a>
    
  </div>

  <div class="footer-bottom">
    
    <!-- tongji -->
    <script
      async
      src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"
    ></script>
    <span class="site-uv">
      <i class="fa fa-user"></i> 访问人数
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
    </span>
    <span class="site-pv">
      <i class="fa fa-eye"></i> 访问总量
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
    </span>
    <br />
      本网站由
    <a href="https://www.upyun.com/?utm_source=lianmeng&utm_medium=referral" target="_blank">
       又拍云 
    </a>
    提供CDN加速/云存储服务 
  </div>
</footer>

</div>
<!-- styles -->

<link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/6.0.0/css/all.min.css">


<link rel="stylesheet" href="https://cdn.staticfile.org/justifiedGallery/3.7.0/css/justifiedGallery.min.css">

<!-- jquery -->

<script src="https://cdn.staticfile.org/jquery/3.4.1/jquery.min.js"></script>


<script src="https://cdn.staticfile.org/justifiedGallery/3.7.0/js/jquery.justifiedGallery.min.js"></script>

<!-- clipboard -->

    
<script src="https://cdn.staticfile.org/clipboard.js/2.0.6/clipboard.min.js"></script>

    <script type="text/javascript">
        $(function () {
            // copy-btn HTML
            var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"复制到粘贴板!\">";
            btn += '<i class="far fa-clone"></i>';
            btn += '</span>';
            // mount it!
            $(".highlight .code pre").before(btn);
            var clip = new ClipboardJS('.btn-copy', {
                target: function (trigger) {
                    return trigger.nextElementSibling;
                }
            });
            clip.on('success', function (e) {
                e.trigger.setAttribute('aria-label', "复制成功!");
                e.clearSelection();
            })
        })
    </script>


<script src="/js/main.js"></script>

<!-- search -->

</body>

</html>