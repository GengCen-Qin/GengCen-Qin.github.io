<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>Rails层级设计演化 | 玲辰书斋</title><meta name="author" content="庚辰"><meta name="copyright" content="庚辰"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="Rails层级设计演化 相关资料   37signal - 层级设计 37signal - concern设计 层级设计翻译 concern设计翻译 gitlab-ddd应用  版本1我们都知道rails初始化项目，在层级拆分上只有两层  controller model  graph TD     A[Controller] --&gt;|调用| B[Model]  controller负责接收请求，">
<meta property="og:type" content="article">
<meta property="og:title" content="Rails层级设计演化">
<meta property="og:url" content="http://www.chengling.cloud/post/Ruby/Rails%E6%9E%B6%E6%9E%84%E5%B1%82%E7%BA%A7%E8%AE%BE%E8%AE%A1.html">
<meta property="og:site_name" content="玲辰书斋">
<meta property="og:description" content="Rails层级设计演化 相关资料   37signal - 层级设计 37signal - concern设计 层级设计翻译 concern设计翻译 gitlab-ddd应用  版本1我们都知道rails初始化项目，在层级拆分上只有两层  controller model  graph TD     A[Controller] --&gt;|调用| B[Model]  controller负责接收请求，">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://www.chengling.cloud/img/default_top_img.jpg">
<meta property="article:published_time" content="2025-07-09T02:30:12.000Z">
<meta property="article:modified_time" content="2025-07-09T14:24:27.338Z">
<meta property="article:author" content="庚辰">
<meta property="article:tag" content="rails">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://www.chengling.cloud/img/default_top_img.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://www.chengling.cloud/post/Ruby/Rails%E6%9E%B6%E6%9E%84%E5%B1%82%E7%BA%A7%E8%AE%BE%E8%AE%A1"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Rails层级设计演化',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2025-07-09 22:24:27'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><link rel="stylesheet" href="APlayer.min.css"><div id="aplayer"></div><script src="https://cdn.jsdelivr.net/gh/radium-bit/res@master/live2d/autoload.js" async></script><script src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js" async></script><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 5.4.2"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/myHead.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">73</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">59</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">21</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 链接</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于笔者</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/img/default_top_img.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">玲辰书斋</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 链接</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于笔者</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Rails层级设计演化</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2025-07-09T02:30:12.000Z" title="发表于 2025-07-09 10:30:12">2025-07-09</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-07-09T14:24:27.338Z" title="更新于 2025-07-09 22:24:27">2025-07-09</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Ruby/">Ruby</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Rails层级设计演化"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="Rails层级设计演化"><a href="#Rails层级设计演化" class="headerlink" title="Rails层级设计演化"></a>Rails层级设计演化</h1><blockquote>
<p>相关资料</p>
</blockquote>
<ol>
<li><a target="_blank" rel="noopener" href="https://dev.37signals.com/vanilla-rails-is-plenty/">37signal - 层级设计</a></li>
<li><a target="_blank" rel="noopener" href="https://dev.37signals.com/good-concerns/">37signal - concern设计</a></li>
<li><a target="_blank" rel="noopener" href="https://xfyuan.github.io/2022/11/vanilla-rails-is-plenty">层级设计翻译</a></li>
<li><a target="_blank" rel="noopener" href="https://dev.37signals.com/good-concerns/">concern设计翻译</a></li>
<li><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1F94y1s7kx/?spm_id_from=333.337.search-card.all.click">gitlab-ddd应用</a></li>
</ol>
<h2 id="版本1"><a href="#版本1" class="headerlink" title="版本1"></a>版本1</h2><p>我们都知道rails初始化项目，在层级拆分上只有两层</p>
<ol>
<li>controller</li>
<li>model</li>
</ol>
<pre class="line-numbers language-mermaid" data-language="mermaid"><code class="language-mermaid"><span class="token keyword">graph</span> TD
    A<span class="token text string">[Controller]</span> <span class="token arrow operator">--></span><span class="token label property">|调用|</span> B<span class="token text string">[Model]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>controller负责接收请求，model负责实现存储，那业务逻辑在哪里实现？</p>
<p>可能为了model的干净，你可能将业务逻辑写到controller中。也有可能为了复用，将业务逻辑写在model中。但不管选择哪种方式，随着业务逻辑的不断迭代，你的controller或者model也逐渐的臃肿。变得难以维护，也有很多人批评说不应该controller直接访问model层，自然而然的大家决定抽离出业务层，比如：Service，Command等等</p>
<h2 id="版本2"><a href="#版本2" class="headerlink" title="版本2"></a>版本2</h2><p>比如我有一个报价单模型，我可能有类似的结构</p>
<pre class="line-numbers language-ruby" data-language="ruby"><code class="language-ruby"><span class="token comment"># controller</span>
<span class="token keyword">class</span> <span class="token class-name">QuotationController</span> <span class="token operator">&lt;</span> ApplicationController
<span class="token keyword">end</span>

<span class="token comment"># Command</span>
<span class="token keyword">class</span> <span class="token class-name">QuotationCommand</span>
  <span class="token keyword">def</span> <span class="token method-definition"><span class="token function">create</span></span>
  <span class="token keyword">end</span>
  
  <span class="token keyword">def</span> <span class="token method-definition"><span class="token function">list</span></span>
  <span class="token keyword">end</span>
  
  <span class="token keyword">def</span> <span class="token method-definition"><span class="token function">modify</span></span>
  <span class="token keyword">end</span>
  
  <span class="token keyword">def</span> <span class="token method-definition"><span class="token function">delete</span></span>
  <span class="token keyword">end</span>
<span class="token keyword">end</span>

<span class="token comment"># model</span>
<span class="token keyword">class</span> <span class="token class-name">Quotation</span> <span class="token operator">&lt;</span> ApplicationRecord
<span class="token keyword">end</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>所有关于报价单的操作我都封装到QuotationCommand中，通过Controller调用Command，最终调用Model</p>
<pre class="line-numbers language-Mermaid" data-language="Mermaid"><code class="language-Mermaid">graph TD
    A[Controller] --&gt;|调用| B[Command]
    B --&gt;|调用| C[Model]<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>可以看到我将增删改查的复杂业务逻辑统一放入到Command中，假如我这时候再来一个新的需求比如我要导出一部分数据，我就简单的称为<code>export</code>吧，根据惯性我会将这个功能也实现到QuotationCommand中。一切自然而然，但是很明显我的这个类早已违反了<strong>单一功能原则（Single responsibility principle）</strong>,直到有一天这个巨无霸的Command也变得臃肿和难以维护，随便一个修改都可能是牵一发而动全身的。没办法我们再按照功能拆分一下吧。</p>
<pre class="line-numbers language-Mermaid" data-language="Mermaid"><code class="language-Mermaid">graph TD
    A[QuotationController] --&gt;|调用| B1[::Quotation::CreateCommand]
    A --&gt;|调用| B2[::Quotation::ModifyCommand]
    A --&gt;|调用| B3[::Quotation::ListCommand]
    A --&gt;|调用| B4[::Quotation::ExportCommand]
    
    B1 --&gt;|调用| C[QuotationModel]
    B2 --&gt;|调用| C
    B3 --&gt;|调用| C
    B4 --&gt;|调用| C<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>看起来很漂亮，每个Command只负责自己的业务，保证职责单一，如果再出现新的业务只需要构建新的Command即可。</p>
<h2 id="版本3"><a href="#版本3" class="headerlink" title="版本3"></a>版本3</h2><p>我们目前的方案有什么问题呢？</p>
<p>比如<code>ExportCommand</code>导出功能是在列表查询的基础上做的，比如我有一个后台管理页面，它拥有一个列表搜索页，通过传递不同的筛选项，查询出不同的数据，使用<code>ListCommand</code>。现在我希望能将查询的数据导成Excel，也就是<code>ExportCommand</code>负责的内容，毫无疑问我查询的功能已经有了，我只需要在<code>ExportCommand</code>中使用<code>ListCommand</code>即可，那这就牵扯到一个问题：</p>
<blockquote>
<p>Command之前是否允许相互调用？</p>
</blockquote>
<p>如果相互允许调用，势必引发耦合性，也就是<code>ListCommand</code>的修改势必会影响到<code>ExportCommand</code></p>
<blockquote>
<p>抽离Command本身可能会有什么问题？</p>
</blockquote>
<p>我们引用一些DDD书评论</p>
<blockquote>
<p>Now, the more common mistake is to give up too easily on fitting the behavior into an appropriate object, gradually slipping towards procedural programming.*</p>
<p>现在，更常见的错误是过于轻易地放弃将行为适配到适当的对象中，逐渐滑向过程编程。</p>
</blockquote>
<blockquote>
<p><em>Don’t lean too heavily toward modeling a domain concept as a Service. Do so only if the circumstances fit. If we aren’t careful, we might start to treat Services as our modeling “silver bullet.” Using Services overzealously will usually result in the negative consequences of creating an Anemic Domain Model, where all the domain logic resides in Services rather than mostly spread across Entities and Value Objects.</em></p>
<p>不要过于倾向于将领域概念建模为一个 Service。仅仅在情况适合时才这样做。如果我们不仔细地话，就可能会开始将 Services 视为建模的“银弹”。过度使用 Services 通常会导致创建贫血领域模型的负面后果，其中所有领域逻辑都驻留在 Services 中，而不是主要分布在实体和值对象中。</p>
</blockquote>
<p>也就是说，如果我们如果不假思索的将所有的行为一股脑的塞进Service层级中，而不考虑内聚性，抽象性，我们会渐渐走向面向过程编程，并且会导致模型<strong>贫血</strong>，即为携带数据的空壳。</p>
<p>所以我们再看看该怎么组织Model？</p>
<hr>
<p>假设我们有一个<code>User</code>模型，随着业务发展，它包含了用户认证、资料管理、权限检查、统计报表等多种功能，导致代码量过大。</p>
<pre class="line-numbers language-ruby" data-language="ruby"><code class="language-ruby"><span class="token comment"># app/models/user.rb</span>
<span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token operator">&lt;</span> ApplicationRecord
  <span class="token comment"># 验证相关</span>
  validates <span class="token symbol">:email</span><span class="token punctuation">,</span> <span class="token symbol">presence</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token symbol">uniqueness</span><span class="token operator">:</span> <span class="token boolean">true</span>
  validates <span class="token symbol">:password</span><span class="token punctuation">,</span> <span class="token symbol">presence</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token symbol">length</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token symbol">minimum</span><span class="token operator">:</span> <span class="token number">8</span> <span class="token punctuation">&#125;</span>
  
  <span class="token comment"># 认证相关</span>
  has_secure_password
  has_many <span class="token symbol">:sessions</span>
  
  <span class="token keyword">def</span> <span class="token method-definition"><span class="token function">generate_auth_token</span></span>
    <span class="token comment"># 生成认证token的逻辑</span>
  <span class="token keyword">end</span>
  
  <span class="token comment"># 资料管理相关</span>
  before_save <span class="token symbol">:format_name</span>
  has_one <span class="token symbol">:profile</span>
  
  <span class="token keyword">def</span> <span class="token method-definition"><span class="token function">full_name</span></span>
    <span class="token string-literal"><span class="token string">"</span><span class="token interpolation"><span class="token delimiter punctuation">#&#123;</span><span class="token content">first_name</span><span class="token delimiter punctuation">&#125;</span></span><span class="token string"> </span><span class="token interpolation"><span class="token delimiter punctuation">#&#123;</span><span class="token content">last_name</span><span class="token delimiter punctuation">&#125;</span></span><span class="token string">"</span></span>
  <span class="token keyword">end</span>
  
  <span class="token keyword">private</span> <span class="token keyword">def</span> <span class="token method-definition"><span class="token function">format_name</span></span>
    <span class="token keyword">self</span><span class="token punctuation">.</span>first_name <span class="token operator">=</span> first_name<span class="token punctuation">.</span>capitalize
    <span class="token keyword">self</span><span class="token punctuation">.</span>last_name <span class="token operator">=</span> last_name<span class="token punctuation">.</span>capitalize
  <span class="token keyword">end</span>
  
  <span class="token comment"># 权限相关</span>
  <span class="token constant">ROLES</span> <span class="token operator">=</span> <span class="token string-literal"><span class="token string">%w[admin moderator user guest]</span></span>
  
  <span class="token keyword">def</span> <span class="token method-definition"><span class="token function">admin</span></span><span class="token operator">?</span>
    role <span class="token operator">==</span> <span class="token string-literal"><span class="token string">'admin'</span></span>
  <span class="token keyword">end</span>
  
  <span class="token keyword">def</span> <span class="token method-definition"><span class="token function">can_edit</span></span><span class="token operator">?</span><span class="token punctuation">(</span>resource<span class="token punctuation">)</span>
    admin<span class="token operator">?</span> <span class="token operator">||</span> resource<span class="token punctuation">.</span>user <span class="token operator">==</span> <span class="token keyword">self</span>
  <span class="token keyword">end</span>
  
  <span class="token comment"># 统计相关</span>
  <span class="token keyword">def</span> <span class="token method-definition"><span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">active_users_count</span></span>
    where<span class="token punctuation">(</span><span class="token symbol">last_active_at</span><span class="token operator">:</span> <span class="token number">1.</span>week<span class="token punctuation">.</span>ago<span class="token operator">..</span><span class="token builtin">Time</span><span class="token punctuation">.</span>current<span class="token punctuation">)</span><span class="token punctuation">.</span>count
  <span class="token keyword">end</span>
  
  <span class="token keyword">def</span> <span class="token method-definition"><span class="token function">activity_score</span></span>
    <span class="token comment"># 计算用户活跃度分数</span>
  <span class="token keyword">end</span>

  <span class="token comment"># ... 更多方法 ...</span>
<span class="token keyword">end</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>里面混乱的组织着各种方法，假如我想找到某个功能，我需要一个个的看，哪些对我是有用的。这也称为<code>Fat Model</code></p>
<p>但如果我们能用Concern进行合理化的拆分聚合，效果就会完全不同</p>
<h3 id="拆分的目录结构："><a href="#拆分的目录结构：" class="headerlink" title="拆分的目录结构："></a>拆分的目录结构：</h3><pre class="line-numbers language-text" data-language="text"><code class="language-text">app/
  models/
    concerns/
      user/
        authenticatable.rb
        profileable.rb
        roleable.rb
        reportable.rb<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="拆分后Concern模块"><a href="#拆分后Concern模块" class="headerlink" title="拆分后Concern模块"></a>拆分后Concern模块</h3><pre class="line-numbers language-ruby" data-language="ruby"><code class="language-ruby"><span class="token comment"># app/models/concerns/user/authenticatable.rb</span>
<span class="token keyword">module</span> <span class="token class-name">User</span><span class="token double-colon punctuation">::</span>Authenticatable
  <span class="token keyword">extend</span> ActiveSupport<span class="token double-colon punctuation">::</span>Concern

  included <span class="token keyword">do</span>
    validates <span class="token symbol">:email</span><span class="token punctuation">,</span> <span class="token symbol">presence</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token symbol">uniqueness</span><span class="token operator">:</span> <span class="token boolean">true</span>
    validates <span class="token symbol">:password</span><span class="token punctuation">,</span> <span class="token symbol">presence</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token symbol">length</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token symbol">minimum</span><span class="token operator">:</span> <span class="token number">8</span> <span class="token punctuation">&#125;</span>
    
    has_secure_password
    has_many <span class="token symbol">:sessions</span>
  <span class="token keyword">end</span>

  <span class="token keyword">def</span> <span class="token method-definition"><span class="token function">generate_auth_token</span></span>
    <span class="token comment"># 生成认证token的逻辑</span>
  <span class="token keyword">end</span>
<span class="token keyword">end</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-ruby" data-language="ruby"><code class="language-ruby"><span class="token comment"># app/models/concerns/user/profileable.rb</span>
<span class="token keyword">module</span> <span class="token class-name">User</span><span class="token double-colon punctuation">::</span>Profileable
  <span class="token keyword">extend</span> ActiveSupport<span class="token double-colon punctuation">::</span>Concern

  included <span class="token keyword">do</span>
    before_save <span class="token symbol">:format_name</span>
    has_one <span class="token symbol">:profile</span>
  <span class="token keyword">end</span>

  <span class="token keyword">def</span> <span class="token method-definition"><span class="token function">full_name</span></span>
    <span class="token string-literal"><span class="token string">"</span><span class="token interpolation"><span class="token delimiter punctuation">#&#123;</span><span class="token content">first_name</span><span class="token delimiter punctuation">&#125;</span></span><span class="token string"> </span><span class="token interpolation"><span class="token delimiter punctuation">#&#123;</span><span class="token content">last_name</span><span class="token delimiter punctuation">&#125;</span></span><span class="token string">"</span></span>
  <span class="token keyword">end</span>

  <span class="token keyword">private</span>

  <span class="token keyword">def</span> <span class="token method-definition"><span class="token function">format_name</span></span>
    <span class="token keyword">self</span><span class="token punctuation">.</span>first_name <span class="token operator">=</span> first_name<span class="token punctuation">.</span>capitalize
    <span class="token keyword">self</span><span class="token punctuation">.</span>last_name <span class="token operator">=</span> last_name<span class="token punctuation">.</span>capitalize
  <span class="token keyword">end</span>
<span class="token keyword">end</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-ruby" data-language="ruby"><code class="language-ruby"><span class="token comment"># app/models/concerns/user/roleable.rb</span>
<span class="token keyword">module</span> <span class="token class-name">User</span><span class="token double-colon punctuation">::</span>Roleable
  <span class="token keyword">extend</span> ActiveSupport<span class="token double-colon punctuation">::</span>Concern

  included <span class="token keyword">do</span>
    <span class="token constant">ROLES</span> <span class="token operator">=</span> <span class="token string-literal"><span class="token string">%w[admin moderator user guest]</span></span>
  <span class="token keyword">end</span>

  <span class="token keyword">def</span> <span class="token method-definition"><span class="token function">admin</span></span><span class="token operator">?</span>
    role <span class="token operator">==</span> <span class="token string-literal"><span class="token string">'admin'</span></span>
  <span class="token keyword">end</span>

  <span class="token keyword">def</span> <span class="token method-definition"><span class="token function">can_edit</span></span><span class="token operator">?</span><span class="token punctuation">(</span>resource<span class="token punctuation">)</span>
    admin<span class="token operator">?</span> <span class="token operator">||</span> resource<span class="token punctuation">.</span>user <span class="token operator">==</span> <span class="token keyword">self</span>
  <span class="token keyword">end</span>
<span class="token keyword">end</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-ruby" data-language="ruby"><code class="language-ruby"><span class="token comment"># app/models/concerns/user/reportable.rb</span>
<span class="token keyword">module</span> <span class="token class-name">User</span><span class="token double-colon punctuation">::</span>Reportable
  <span class="token keyword">extend</span> ActiveSupport<span class="token double-colon punctuation">::</span>Concern

  class_methods <span class="token keyword">do</span>
    <span class="token keyword">def</span> <span class="token method-definition"><span class="token function">active_users_count</span></span>
      where<span class="token punctuation">(</span><span class="token symbol">last_active_at</span><span class="token operator">:</span> <span class="token number">1.</span>week<span class="token punctuation">.</span>ago<span class="token operator">..</span><span class="token builtin">Time</span><span class="token punctuation">.</span>current<span class="token punctuation">)</span><span class="token punctuation">.</span>count
    <span class="token keyword">end</span>
  <span class="token keyword">end</span>

  <span class="token keyword">def</span> <span class="token method-definition"><span class="token function">activity_score</span></span>
    <span class="token comment"># 计算用户活跃度分数</span>
  <span class="token keyword">end</span>
<span class="token keyword">end</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="拆分后的User模型"><a href="#拆分后的User模型" class="headerlink" title="拆分后的User模型"></a>拆分后的User模型</h3><pre class="line-numbers language-ruby" data-language="ruby"><code class="language-ruby"><span class="token comment"># app/models/user.rb</span>
<span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token operator">&lt;</span> ApplicationRecord
  <span class="token keyword">include</span> User<span class="token double-colon punctuation">::</span>Authenticatable
  <span class="token keyword">include</span> User<span class="token double-colon punctuation">::</span>Profileable
  <span class="token keyword">include</span> User<span class="token double-colon punctuation">::</span>Roleable
  <span class="token keyword">include</span> User<span class="token double-colon punctuation">::</span>Reportable
  
  <span class="token comment"># 这里只保留模型特有的或无法分类的方法</span>
<span class="token keyword">end</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这样拆分后，可能都不用构建特定的Command，模型本身维护拆分良好的功能，来让Controller直接进行调用</p>
<p>但是这也要求团队内的成员遵守统一的规范和要求，并且具有良好的抽象化思想，这一点很难，最难的可能是如何给你的模块命名🤣，因为它直接反映了该模块儿的内涵。</p>
<hr>
<p>简略总结几点：</p>
<ol>
<li>鼓励构建<code>rich domain model</code>，不过为了避免<code>Fat</code><ol>
<li>使用Concern来组织Model的代码</li>
<li>将复杂功能委托到额外的对象系统（PORO）</li>
<li>ActiveRecord和Poro视为一整套领域模型，而至于是否需要持久化，业务逻辑消费者并不在意</li>
</ol>
</li>
<li>对于复杂的行为，可构建Service/Command，但是需要谨慎和良好的设计</li>
</ol>
<p>比较有趣的是：<code>37signal</code>很激进，觉得Service层都是没有必要的。</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="http://www.chengling.cloud">庚辰</a></span></div><!--.post-copyright__type--><!--  span.post-copyright-meta= _p('post.copyright.link') + ": "--><!--  span.post-copyright-info--><!--    a(href=url_for(url))= theme.post_copyright.decode ? decodeURI(url) : url--><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://www.chengling.cloud" target="_blank">玲辰书斋</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/rails/">rails</a></div><div class="post_share"><div class="social-share" data-image="/img/default_top_img.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="next-post pull-full"><a href="/post/Ruby/%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1.html"><img class="next-cover" src="/img/default_top_img.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info"></div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/myHead.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">庚辰</div><div class="author-info__description">要么读书，要么旅行，身体和心灵总有一个要在路上.</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">73</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">59</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">21</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/GengCen-Qin"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Rails%E5%B1%82%E7%BA%A7%E8%AE%BE%E8%AE%A1%E6%BC%94%E5%8C%96"><span class="toc-number">1.</span> <span class="toc-text">Rails层级设计演化</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%89%88%E6%9C%AC1"><span class="toc-number">1.1.</span> <span class="toc-text">版本1</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%89%88%E6%9C%AC2"><span class="toc-number">1.2.</span> <span class="toc-text">版本2</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%89%88%E6%9C%AC3"><span class="toc-number">1.3.</span> <span class="toc-text">版本3</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8B%86%E5%88%86%E7%9A%84%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84%EF%BC%9A"><span class="toc-number">1.3.1.</span> <span class="toc-text">拆分的目录结构：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8B%86%E5%88%86%E5%90%8EConcern%E6%A8%A1%E5%9D%97"><span class="toc-number">1.3.2.</span> <span class="toc-text">拆分后Concern模块</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8B%86%E5%88%86%E5%90%8E%E7%9A%84User%E6%A8%A1%E5%9E%8B"><span class="toc-number">1.3.3.</span> <span class="toc-text">拆分后的User模型</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/post/Ruby/Rails%E6%9E%B6%E6%9E%84%E5%B1%82%E7%BA%A7%E8%AE%BE%E8%AE%A1.html" title="Rails层级设计演化"><img src="/img/default_top_img.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Rails层级设计演化"/></a><div class="content"><a class="title" href="/post/Ruby/Rails%E6%9E%B6%E6%9E%84%E5%B1%82%E7%BA%A7%E8%AE%BE%E8%AE%A1.html" title="Rails层级设计演化">Rails层级设计演化</a><time datetime="2025-07-09T02:30:12.000Z" title="发表于 2025-07-09 10:30:12">2025-07-09</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/post/Ruby/%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1.html" title="无题"><img src="/img/default_top_img.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="无题"/></a><div class="content"><a class="title" href="/post/Ruby/%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1.html" title="无题">无题</a><time datetime="2025-05-23T13:28:31.651Z" title="发表于 2025-05-23 21:28:31">2025-05-23</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/post/%E5%B7%A5%E5%85%B7/%E8%AD%A6%E6%83%95AI.html" title="警惕AI"><img src="/img/default_top_img.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="警惕AI"/></a><div class="content"><a class="title" href="/post/%E5%B7%A5%E5%85%B7/%E8%AD%A6%E6%83%95AI.html" title="警惕AI">警惕AI</a><time datetime="2025-04-06T10:00:00.000Z" title="发表于 2025-04-06 18:00:00">2025-04-06</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/post/Ruby/Ruby%E5%85%83%E7%BC%96%E7%A8%8B%E5%AE%9E%E6%88%98.html" title="Ruby元编程实战"><img src="/img/default_top_img.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Ruby元编程实战"/></a><div class="content"><a class="title" href="/post/Ruby/Ruby%E5%85%83%E7%BC%96%E7%A8%8B%E5%AE%9E%E6%88%98.html" title="Ruby元编程实战">Ruby元编程实战</a><time datetime="2025-02-09T05:03:04.000Z" title="发表于 2025-02-09 13:03:04">2025-02-09</time></div></div><div class="aside-list-item"><div class="content"><a class="title" href="/post/%E6%B5%8B%E8%AF%95/RSpec%20%E6%B5%8B%E8%AF%95%E7%A4%BA%E4%BE%8B%E4%B8%8E%E6%8A%80%E5%B7%A7%E8%AF%B4%E6%98%8E.html" title="RSpec 测试示例与技巧说明">RSpec 测试示例与技巧说明</a><time datetime="2025-01-12T09:24:42.000Z" title="发表于 2025-01-12 17:24:42">2025-01-12</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2025 By 庚辰</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a><br>
<a href="https://beian.miit.gov.cn/"  style="color:#f72b07" target="_blank">陕ICP备2022014054号</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"></div><div class="aplayer no-destroy" data-id="498210" data-server="netease" data-type="song" data-fixed="true" data-autoplay="true" data-lrcType="-1"> </div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/metingjs/dist/Meting.min.js"></script><script src="https://cdn.jsdelivr.net/npm/pjax/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]

var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {

  // removeEventListener scroll 
  window.tocScrollFn && window.removeEventListener('scroll', window.tocScrollFn)
  window.scrollCollect && window.removeEventListener('scroll', scrollCollect)

  document.getElementById('rightside').style.cssText = "opacity: ''; transform: ''"
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')

  typeof disqusjs === 'object' && disqusjs.destroy()
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof chatBtnFn === 'function' && chatBtnFn()
  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', (e) => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>